<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Pernataan DPS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #ffffff;
      --text: #000000;
      --table-header: #f0f0f0;
      --border: #cccccc;
      --highlight-minus: #ffcccc;
    }

    body.dark {
      --bg: #1e1e1e;
      --text: #ffffff;
      --table-header: #2a2a2a;
      --border: #555555;
      --highlight-minus: #661111;
    }

    body.blue {
      --bg: #e6f0ff;
      --text: #003366;
      --table-header: #cce0ff;
      --border: #99c2ff;
      --highlight-minus: #ff9999;
    }

    body.sepia {
      --bg: #f4ecd8;
      --text: #5b4636;
      --table-header: #e3d7c1;
      --border: #c5b79e;
      --highlight-minus: #f8c0a0;
    }

    body.reddark {
      --bg: #1e0000;
      --text: #ff4444;
      --table-header: #300000;
      --border: #772222;
      --highlight-minus: #660000;
    }

    body.mars {
      --bg: #451804;
      --text: #f0e7e7;
      --table-header: #c1440e;
      --border: 	#e77d11;
      --highlight-minus: #fda600;
    }

    body {
      background-color: var(--bg);
      color: var(--text);
      font-family: sans-serif;
      padding: 1rem;
      transition: background 0.3s, color 0.3s;
      overflow: hidden;
    }

    .logo,
    header {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    #status-bar {
      margin-top: 5px;
      color: gray;
      font-size: 0.9em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #spinner {
      width: 14px;
      height: 14px;
      border: 2px solid var(--border);
      border-top: 2px solid var(--text);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .mobile-toggle {
      display: none;
      width: 100%;
      margin-bottom: 10px;
      font-size: 1em;
      background-color: var(--table-header);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 0 0 6px 6px;
      cursor: pointer;
    }

    .filter-wrapper .filter-inner {
      max-height: 1000px;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .filter-wrapper:not(.show) .filter-inner {
      max-height: 0;
    }

    #themeSelector {
      margin-left: auto;
    }

    .tab-buttons {
      display: flex;
      gap: 8px;
    }

    .tab-buttons button {
      border-radius: 999px;
      background-color: transparent;
      border: 1px solid var(--border);
      padding: 8px 16px;
      color: var(--text);
      cursor: pointer;
      transition: all 0.3s ease;
      background-color: rgba(255, 255, 255, 0.1);
    }

    .tab-buttons button.active {
      background-color: var(--bg);
      color: var(--text);
      box-shadow: 0 0 0 2px var(--text) inset;
      font-weight: bold;
      border-bottom: 2px solid var(--text);
    }

    .mobile-toggle:hover,
    .tab-buttons button:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .search-wrapper {
      position: relative;
      width: 125vw;
      max-width: 400px;
    }

    .search-wrapper input {
      width: 100%;
      padding: 0.5rem 5rem 0.5rem 0.5rem;
      box-sizing: border-box;
    }

    .clear-button {
      border-radius: 999px;
      position: absolute;
      padding: 0 0.2rem;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.2rem;
      color: var(--text);
      cursor: pointer;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.1s ease, background-color 0.3s ease, color 0.3s ease;
      z-index: 50;
    }

    .clear-button.show {
      opacity: 1;
      pointer-events: auto;
    }

    .clear-button:active {
      transform: translateY(-50%) scale(0.85);
    }

    .clear-button:hover {
      background-color: var(--text);
      color: var(--table-header);
    }

    #lantaiFilter {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
      margin-bottom: 10px;
    }

    .table-wrapper {
      max-height: 80vh;
      overflow-y: auto;
      overflow-x: auto;
    }

    #data-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: auto;
      margin-bottom: 3em;
      border-collapse: collapse;
      border: 1px solid var(--border);
    }

    .highlight-minus {
      background-color: var(--highlight-minus);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    thead {
      position: sticky;
      top: 0;
      background-color: var(--border);
    }
    
    th {
      position: relative;
      z-index: 100;
      cursor: pointer;
      background-color: var(--table-header);
      background-clip: padding-box;
    }

    th.sort-asc::after {
      content: ' ðŸ”¼';
    }

    th.sort-desc::after {
      content: ' ðŸ”½';
    }
    

    th, td {
      border: 1px solid var(--border);
      padding: 6px 10px;
      text-align: left;
      white-space: nowrap;
    }

    .resizer {
      position: absolute;
      right: 0;
      top: 0;
      width: 5px;
      height: 100%;
      cursor: col-resize;
      -webkit-user-select: none;
      user-select: none;
    }

    /* responsive */
    @media (max-width: 768px) {
      header {
        flex-direction: column;
        align-items: stretch;
      }

      .mobile-toggle {
        display: block;
      }

      .filter-wrapper .filter-inner {
        display: none;
      }

      .filter-wrapper.show .filter-inner {
        display: block;
      }

      .search-wrapper {
        width: 100%;
        max-width: none;
      }

      #searchInput {
        width: 100%;
        box-sizing: border-box;
      }

      #themeSelector {
        margin-left: 0;
        width: 100%;
      }

      .tab-buttons {
        flex-direction: column;
      }

      .table-wrapper {
        overflow-x: auto;
        max-width: 100%;
        -webkit-overflow-scrolling: touch;
      }

      #lantaiFilter{ 
        gap: 15px;
      }

      th, td {
        padding: 8px 6px;
        font-size: 14px;
      }

      h2 {
        font-size: 1.2em;
      }

      #status-bar {
        flex-direction: row;
        justify-content: space-between;
        font-size: 0.85em;
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body class="light">
  <div class="logo">
    <h2>Pernataan DPS</h2>

    <div id="status-bar">
      Last updated: <span id="lastUpdated">-</span>
      <span id="spinner"></span>
    </div>
  </div>

  <div class="search-wrapper">
    <input type="text" id="searchInput" placeholder="Cari SKU atau Nama..." oninput="onSearchInput()" />
    <span class="clear-button" onclick="clearSearch()">Ã—</span>
  </div>

  <div class="filter-wrapper">
    <button id="toggleFilterBtn" class="mobile-toggle">ðŸ”½ Filter</button>

    <div class="filter-inner">
      <header>
        <div class="tab-buttons">
          <button onclick="setTab('all')" id="tabAll" class="active">Semua Data</button>
          <button onclick="setTab('minus')" id="tabMinus">Stok Minus</button>
        </div>

        <select id="themeSelector" aria-label="themeSelector" onchange="changeTheme(this.value)">
          <option value="light">Terang</option>
          <option value="dark">Gelap</option>
          <option value="blue">Biru</option>
          <option value="sepia">Sepia</option>
          <option value="reddark">Gelap Merah</option>
          <option value="mars">Mars</option>
        </select>
      </header>

      <div id="lantaiFilter"></div>
    </div>
  </div>

  <div class="table-wrapper" id="tableWrapper">
    <table id="data-table">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const columnOrder = [
      "SKU", "NAMA",
      "A12 - 1", "A12 - 2", "A12 - 3", "A12 - 4",
      "A19 - 1", "A19 - 2", "A19 - 3",
      "A20 - 1", "A20 - 3",
      "LTC", "Grand Total"
    ];

    const lantaiColumns = columnOrder.slice(2, -1);
    let data = [];
    let tab = 'all';
    let batchSize = 100;
    let renderedRows = 0;
    let currentSort = { column: null, asc: true };

    function changeTheme(theme) {
      document.body.className = theme;
      localStorage.setItem("selectedTheme", theme);
    }

    function loadSavedTheme() {
      const saved = localStorage.getItem("selectedTheme");
      if (saved) {
        document.body.className = saved;
        const selector = document.getElementById("themeSelector");
        if (selector) selector.value = saved;
      }
    }

    function setTab(value) {
      tab = value;
      document.getElementById("tabAll").classList.remove("active");
      document.getElementById("tabMinus").classList.remove("active");
      document.getElementById("tab" + capitalize(value)).classList.add("active");
      renderedRows = 0;
      document.querySelector("#data-table tbody").innerHTML = '';
      renderTable();
    }

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function getSelectedFloors() {
      return JSON.parse(localStorage.getItem("selectedFloors") || JSON.stringify(lantaiColumns));
    }

    function saveSelectedFloors(selected) {
      localStorage.setItem("selectedFloors", JSON.stringify(selected));
      renderedRows = 0;
      document.querySelector("#data-table tbody").innerHTML = '';
      renderTable();
    }

    function setupLantaiCheckboxes() {
      const container = document.getElementById("lantaiFilter");
      container.innerHTML = '';
      lantaiColumns.forEach(col => {
        const label = document.createElement("label");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = col;
        checkbox.checked = getSelectedFloors().includes(col);
        checkbox.onchange = () => {
          const selected = Array.from(document.querySelectorAll("#lantaiFilter input:checked"))
                                .map(cb => cb.value);
          saveSelectedFloors(selected);
        };
        label.appendChild(checkbox);
        label.append(" ", col);
        container.appendChild(label);
      });
    }

    function initResize(index) {
      return function (e) {
        const th = document.querySelectorAll("th")[index];
        const startX = e.pageX;
        const startWidth = th.offsetWidth;

        function onMouseMove(e) {
          const newWidth = startWidth + (e.pageX - startX);
          th.style.width = newWidth + "px";
        }

        function onMouseUp() {
          document.removeEventListener("mousemove", onMouseMove);
          document.removeEventListener("mouseup", onMouseUp);
        }

        document.addEventListener("mousemove", onMouseMove);
        document.addEventListener("mouseup", onMouseUp);
      };
    }

    function sortTable(column) {
      currentSort.asc = currentSort.column === column ? !currentSort.asc : true;
      currentSort.column = column;
      
      data.sort((a, b) => {
        let valA = a[column] ?? '';
        let valB = b[column] ?? '';
        return currentSort.asc
          ? valA.toString().localeCompare(valB.toString(), undefined, { numeric: true })
          : valB.toString().localeCompare(valA.toString(), undefined, { numeric: true });
      });
      renderedRows = 0;
      document.querySelector("#data-table tbody").innerHTML = '';
      renderTable();
    }

    function renderTable() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const selectedFloors = getSelectedFloors();
      const dynamicColumns = ["SKU", "NAMA", ...selectedFloors, "Grand Total"];
      const thead = document.querySelector("#data-table thead");
      const tbody = document.querySelector("#data-table tbody");

      // Clear and re-render header
      thead.innerHTML = '';
      const headerRow = document.createElement('tr');
      dynamicColumns.forEach((col, index) => {
        const th = document.createElement('th');
        th.textContent = col;
        th.onclick = () => sortTable(col);
        if (currentSort.column === col) {
          th.classList.add(currentSort.asc ? "sort-asc" : "sort-desc");
        }

        // Add resizer
        const resizer = document.createElement('div');
        resizer.classList.add('resizer');
        resizer.addEventListener('mousedown', initResize(index));
        th.appendChild(resizer);

        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);

      // Filter data by tab and search
      let filtered = data.filter(row => {
        const keyword = `${row["SKU"] ?? ''} ${row["NAMA"] ?? ''}`.toLowerCase();
        const searchMatch = keyword.includes(search);
        const minusMatch = tab !== 'minus' || selectedFloors.some(c => Number(row[c]) < 0) || Number(row["Grand Total"]) < 0;
        return searchMatch && minusMatch;
      });

      // Render rows
      const fragment = document.createDocumentFragment();
      const slice = filtered.slice(renderedRows, renderedRows + batchSize);
      slice.forEach(row => {
        const tr = document.createElement('tr');
        dynamicColumns.forEach(col => {
          const td = document.createElement('td');
          let value = row[col];
          if (value === undefined || value === "") value = "-";
          td.textContent = value;
          if (!isNaN(value) && Number(value) < 0) td.classList.add("highlight-minus");
          tr.appendChild(td);
        });
        fragment.appendChild(tr);
      });

      tbody.appendChild(fragment);
      renderedRows += batchSize;
    }

    function refreshTable() {
      renderedRows = 0;
      document.querySelector("#data-table tbody").innerHTML = '';
      renderTable();
    }

    function onSearchInput() {
      const input = document.getElementById("searchInput");
      const clearBtn = document.querySelector(".clear-button");
      if (input.value.trim() !== "") {
        clearBtn.classList.add("show");
      } else {
        clearBtn.classList.remove("show");
      }
      refreshTable();
    }

    function clearSearch() {
      const input = document.getElementById("searchInput");
      input.value = "";
      onSearchInput(); // hide button
    }

    async function fetchData() {
      document.getElementById("spinner").style.display = "inline-block";

      const [stockRes, skuRes] = await Promise.all([
        fetch("https://pernataan-db-default-rtdb.asia-southeast1.firebasedatabase.app/rekap.json"),
        fetch("https://pernataan-db-default-rtdb.asia-southeast1.firebasedatabase.app/sku_master.json")
      ]);
      
      const stockJson = await stockRes.json();
      const skuJson = await skuRes.json();

      const stockData = stockJson || {};
      const skuData = skuJson || {};

      // Merge SKU master with stock
      data = Object.values(skuData).map(item => ({
        ...item,
        ...(stockData[item.SKU] || {}) // fill with stock if any
      }));

      setupLantaiCheckboxes();
      document.querySelector("#data-table thead").innerHTML = '';
      document.querySelector("#data-table tbody").innerHTML = '';
      renderedRows = 0;
      renderTable();
      document.getElementById("lastUpdated").textContent = new Date().toLocaleTimeString('id-ID');
      document.getElementById("spinner").style.display = "none";
    }

    document.getElementById("tableWrapper").addEventListener("scroll", () => {
      const wrapper = document.getElementById("tableWrapper");
      if (wrapper.scrollTop + wrapper.clientHeight >= wrapper.scrollHeight - 10) {
        renderTable();
      }
    });

    document.getElementById("toggleFilterBtn").addEventListener("click", function () {
      const wrapper = document.querySelector(".filter-wrapper");
      const button = document.getElementById("toggleFilterBtn");
      const isOpen = wrapper.classList.toggle("show");

      button.textContent = (isOpen ? "ðŸ”¼" : "ðŸ”½") + " Filter";
    });

    loadSavedTheme();
    fetchData();
    setInterval(fetchData, 60000);
  </script>
</body>
</html>
